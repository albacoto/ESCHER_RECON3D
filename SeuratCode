
```{r}
library(Seurat)

ht_list <- list() #store the information map cell_barcode to hashID (or sampleID or indiviualID)
toc_list <- list() # store the raw count matrix

# Loop through batches (Batch1Channel1 to Batch8Channel1)
for (i in 1:8) {
  # Construct the path dynamically
  path <- paste0("/maps/projects/thor/people/gjl413/projects/psychENCODE/data/SZBDMulti-Seq/CellrangerOutput_Intron/Batch", 
                 i, 
                 "Channel1/outs/filtered_feature_bc_matrix/")
  counts <- Read10X(data.dir = path)
  
  
  toc_list[[i]] <- as.data.frame(counts$`Gene Expression`)
  df2 <- as.data.frame(counts$`Antibody Capture`)
  
  
  cellhash <- CreateSeuratObject(counts = df2,project = "cell_hashing", assay = "HTO")
  cellhash <- NormalizeData(cellhash, assay = "HTO", normalization.method = "CLR")
  cellhash <- HTODemux(cellhash, assay = "HTO", positive.quantile = 0.85)
  
  
  ht_list[[i]] <- as.data.frame(cellhash$hash.ID)

}

saveRDS(ht_list,file = "/maps/projects/thor/people/tbm613/hashtag5.rds")
saveRDS(toc_list,file = "/maps/projects/thor/people/tbm613/toc5.rds")

toc_list <- readRDS("/maps/projects/thor/people/tbm613/toc5.rds")
ht_list <- readRDS("/maps/projects/thor/people/tbm613/hashtag5.rds")

ht_list
```

```{r} 1ST GENE EXPRESSION AND THEN ADD THE HTO COUNTS

library(Seurat)

ht_list <- list() # store mapping from cell barcode to hash ID
toc_list <- list() # store raw gene expression counts

# Loop through batches
for (i in 1:8) {
  path <- paste0("/maps/projects/thor/people/gjl413/projects/psychENCODE/data/SZBDMulti-Seq/CellrangerOutput_Intron/Batch", 
                 i, 
                 "Channel1/outs/filtered_feature_bc_matrix/")
  counts <- Read10X(data.dir = path)

  # Gene expression matrix
  gene_counts <- counts$`Gene Expression`
  hto_counts <- counts$`Antibody Capture`
  
  # Create Seurat object using gene expression counts
  seurat_obj <- CreateSeuratObject(counts = gene_counts, project = paste0("Batch", i))
  
  # Add HTO data as a separate assay
  seurat_obj[["HTO"]] <- CreateAssayObject(counts = hto_counts)
  
  # Normalize HTO data and perform demultiplexing
  seurat_obj <- NormalizeData(seurat_obj, assay = "HTO", normalization.method = "CLR")
  seurat_obj <- HTODemux(seurat_obj, assay = "HTO", positive.quantile = 0.85)
  
  # Store results
  toc_list[[i]] <- as.data.frame(gene_counts)  # Save gene expression
  ht_list[[i]] <- as.data.frame(seurat_obj$hash.ID)  # Save hash assignments
}

# Save results
saveRDS(ht_list, file = "/maps/projects/thor/people/tbm613/hashtag3.rds")
saveRDS(toc_list, file = "/maps/projects/thor/people/tbm613/toc3.rds")
```


3rd try:
library(Seurat)

batch_list <- list()  # Store Seurat objects from each batch
ht_list <- list()  # Store hash.ID mapping
toc_list <- list() # Store raw gene expression counts

# Loop through batches (Batch1Channel1 to Batch8Channel1)
for (i in 1:8) {
  # Construct the path dynamically
  path <- paste0("/maps/projects/thor/people/gjl413/projects/psychENCODE/data/SZBDMulti-Seq/CellrangerOutput_Intron/Batch", 
                 i, 
                 "Channel1/outs/filtered_feature_bc_matrix/")
  
  counts <- Read10X(data.dir = path)
  
  # Extract Gene Expression and HTO counts
  gene_counts <- counts$`Gene Expression`
  hto_counts <- counts$`Antibody Capture`
  
  # Step 1: Create Seurat object using HTO (Antibody Capture) data first
  cellhash <- CreateSeuratObject(counts = hto_counts, project = paste0("Batch", i), assay = "HTO")
  
  # Normalize and demultiplex HTO data
  cellhash <- NormalizeData(cellhash, assay = "HTO", normalization.method = "CLR")
  cellhash <- HTODemux(cellhash, assay = "HTO", positive.quantile = 0.75)  # Adjusted to avoid excessive doublets

  # Store hash.ID mapping
  ht_list[[i]] <- as.data.frame(cellhash$hash.ID)
  
  # Step 2: Add the Gene Expression counts for all cells (NO subsetting yet)
  cellhash[["RNA"]] <- CreateAssayObject(counts = gene_counts[, colnames(cellhash)]) 
  
  # Store the gene expression counts for reference
  toc_list[[i]] <- as.data.frame(gene_counts[, colnames(cellhash)]) 
  
  # Store each batch in a list
  batch_list[[i]] <- cellhash
}

# Step 3: Merge All Batches Into One Seurat Object (WITHOUT Subsetting Singlets)
seurat_obj <- merge(batch_list[[1]], y = batch_list[2:8], add.cell.ids = paste0("Batch", 1:8), project = "Merged_SZBD")

# Save results
saveRDS(seurat_obj, file = "/maps/projects/thor/people/tbm613/seurat_merged.rds")
saveRDS(ht_list, file = "/maps/projects/thor/people/tbm613/hashtag5.rds")
saveRDS(toc_list, file = "/maps/projects/thor/people/tbm613/toc5.rds")


4th try with gene names?

library(Seurat)

batch_list <- list()  # Store Seurat objects for each batch
ht_list <- list()  # Store hash.ID mapping
toc_list <- list() # Store raw gene expression counts

# Loop through batches (Batch1Channel1 to Batch8Channel1)
for (i in 1:8) {
  # Construct the path dynamically
  path <- paste0("/maps/projects/thor/people/gjl413/projects/psychENCODE/data/SZBDMulti-Seq/CellrangerOutput_Intron/Batch", 
                 i, 
                 "Channel1/outs/filtered_feature_bc_matrix/")
  
  counts <- Read10X(data.dir = path)  # Read raw data
  
  # ✅ Extract Gene Expression and HTO counts
  gene_counts <- counts$`Gene Expression`
  hto_counts <- counts$`Antibody Capture`
  
  # ✅ Ensure Gene Names Are Assigned (before creating Seurat object)
  rownames(gene_counts) <- rownames(counts$`Gene Expression`)  # Assign gene names
  
  # ✅ Step 1: Create Seurat object using HTO data first
  cellhash <- CreateSeuratObject(counts = hto_counts, project = paste0("Batch", i), assay = "HTO")
  
  # Normalize and demultiplex HTO data
  cellhash <- NormalizeData(cellhash, assay = "HTO", normalization.method = "CLR")
  cellhash <- HTODemux(cellhash, assay = "HTO", positive.quantile = 0.75)  # Adjust threshold if needed

  # Store hash.ID mapping
  ht_list[[i]] <- as.data.frame(cellhash$hash.ID)
  
  # ✅ Step 2: Add Gene Expression Data to the Seurat Object (with correct gene names)
  cellhash[["RNA"]] <- CreateAssayObject(counts = gene_counts[, colnames(cellhash)]) 
  
  # Store gene expression counts
  toc_list[[i]] <- as.data.frame(gene_counts[, colnames(cellhash)]) 
  
  # ✅ Store each batch in a list
  batch_list[[i]] <- cellhash
}

# ✅ Step 3: Merge All Batches Into One Seurat Object
seurat_obj <- merge(batch_list[[1]], y = batch_list[2:8], add.cell.ids = paste0("Batch", 1:8), project = "Merged_SZBD")

# ✅ Save results
saveRDS(seurat_obj, file = "/maps/projects/thor/people/tbm613/seurat_merged6.rds")
saveRDS(ht_list, file = "/maps/projects/thor/people/tbm613/hashtag6.rds")
saveRDS(toc_list, file = "/maps/projects/thor/people/tbm613/toc6.rds")

# ✅ Verify Gene Names Are Correct
head(rownames(seurat_obj[["RNA"]]@counts))  # Should show gene names

# ✅ Verify Hash Assignments
table(seurat_obj$hash.ID)

----------

1. VERIFY THE HTO DEMULTIPLEXING RESULTS & gene names

table(seurat_obj$HTO_classification.global)
table(seurat_obj$hash.ID)


head(rownames(seurat_obj[["RNA"]]@counts))
head(colnames(seurat_obj))


2. REMOVE DOUBLETS AND NEGATIVES

seurat_obj <- subset(seurat_obj, subset = HTO_classification.global == "Singlet")
table(seurat_obj$HTO_classification.global)


3. SUBSET ONLY SZ & CON

unique(seurat_obj$hash.ID)
seurat_obj <- subset(seurat_obj, subset = hash.ID %in% grep("^SZ|^CON", unique(seurat_obj$hash.ID), value = TRUE))
table(seurat_obj$hash.ID)

VlnPlot(seurat_obj, 
        features = c("nFeature_RNA", "nCount_RNA"), 
        group.by = "HTO_classification.global", 
        pt.size = 0,  # Removes points
        ncol = 2)
