
```{r}
library(Seurat)

ht_list <- list() #store the information map cell_barcode to hashID (or sampleID or indiviualID)
toc_list <- list() # store the raw count matrix

# Loop through batches (Batch1Channel1 to Batch8Channel1)
for (i in 1:8) {
  # Construct the path dynamically
  path <- paste0("/maps/projects/thor/people/gjl413/projects/psychENCODE/data/SZBDMulti-Seq/CellrangerOutput_Intron/Batch", 
                 i, 
                 "Channel1/outs/filtered_feature_bc_matrix/")
  counts <- Read10X(data.dir = path)
  
  
  toc_list[[i]] <- as.data.frame(counts$`Gene Expression`)
  df2 <- as.data.frame(counts$`Antibody Capture`)
  
  
  cellhash <- CreateSeuratObject(counts = df2,project = "cell_hashing", assay = "HTO")
  cellhash <- NormalizeData(cellhash, assay = "HTO", normalization.method = "CLR")
  cellhash <- HTODemux(cellhash, assay = "HTO", positive.quantile = 0.85)
  
  
  ht_list[[i]] <- as.data.frame(cellhash$hash.ID)

}

saveRDS(ht_list,file = "/maps/projects/thor/people/tbm613/hashtag5.rds")
saveRDS(toc_list,file = "/maps/projects/thor/people/tbm613/toc5.rds")

toc_list <- readRDS("/maps/projects/thor/people/tbm613/toc5.rds")
ht_list <- readRDS("/maps/projects/thor/people/tbm613/hashtag5.rds")

ht_list
```

```{r} 1ST GENE EXPRESSION AND THEN ADD THE HTO COUNTS

library(Seurat)

ht_list <- list() # store mapping from cell barcode to hash ID
toc_list <- list() # store raw gene expression counts

# Loop through batches
for (i in 1:8) {
  path <- paste0("/maps/projects/thor/people/gjl413/projects/psychENCODE/data/SZBDMulti-Seq/CellrangerOutput_Intron/Batch", 
                 i, 
                 "Channel1/outs/filtered_feature_bc_matrix/")
  counts <- Read10X(data.dir = path)

  # Gene expression matrix
  gene_counts <- counts$`Gene Expression`
  hto_counts <- counts$`Antibody Capture`
  
  # Create Seurat object using gene expression counts
  seurat_obj <- CreateSeuratObject(counts = gene_counts, project = paste0("Batch", i))
  
  # Add HTO data as a separate assay
  seurat_obj[["HTO"]] <- CreateAssayObject(counts = hto_counts)
  
  # Normalize HTO data and perform demultiplexing
  seurat_obj <- NormalizeData(seurat_obj, assay = "HTO", normalization.method = "CLR")
  seurat_obj <- HTODemux(seurat_obj, assay = "HTO", positive.quantile = 0.85)
  
  # Store results
  toc_list[[i]] <- as.data.frame(gene_counts)  # Save gene expression
  ht_list[[i]] <- as.data.frame(seurat_obj$hash.ID)  # Save hash assignments
}

# Save results
saveRDS(ht_list, file = "/maps/projects/thor/people/tbm613/hashtag3.rds")
saveRDS(toc_list, file = "/maps/projects/thor/people/tbm613/toc3.rds")
```


3rd try:
library(Seurat)

batch_list <- list()  # Store Seurat objects from each batch
ht_list <- list()  # Store hash.ID mapping
toc_list <- list() # Store raw gene expression counts

# Loop through batches (Batch1Channel1 to Batch8Channel1)
for (i in 1:8) {
  # Construct the path dynamically
  path <- paste0("/maps/projects/thor/people/gjl413/projects/psychENCODE/data/SZBDMulti-Seq/CellrangerOutput_Intron/Batch", 
                 i, 
                 "Channel1/outs/filtered_feature_bc_matrix/")
  
  counts <- Read10X(data.dir = path)
  
  # Extract Gene Expression and HTO counts
  gene_counts <- counts$`Gene Expression`
  hto_counts <- counts$`Antibody Capture`
  
  # ✅ Step 1: Create Seurat object using HTO (Antibody Capture) data first
  cellhash <- CreateSeuratObject(counts = hto_counts, project = paste0("Batch", i), assay = "HTO")
  
  # Normalize and demultiplex HTO data
  cellhash <- NormalizeData(cellhash, assay = "HTO", normalization.method = "CLR")
  cellhash <- HTODemux(cellhash, assay = "HTO", positive.quantile = 0.75)  # Adjusted to avoid excessive doublets

  # Store hash.ID mapping
  ht_list[[i]] <- as.data.frame(cellhash$hash.ID)
  
  # ✅ Step 2: Add the Gene Expression counts for all cells (NO subsetting yet)
  cellhash[["RNA"]] <- CreateAssayObject(counts = gene_counts[, colnames(cellhash)]) 
  
  # Store the gene expression counts for reference
  toc_list[[i]] <- as.data.frame(gene_counts[, colnames(cellhash)]) 
  
  # ✅ Store each batch in a list
  batch_list[[i]] <- cellhash
}

# ✅ Step 3: Merge All Batches Into One Seurat Object (WITHOUT Subsetting Singlets)
seurat_obj <- merge(batch_list[[1]], y = batch_list[2:8], add.cell.ids = paste0("Batch", 1:8), project = "Merged_SZBD")

# ✅ Save results
saveRDS(seurat_obj, file = "/maps/projects/thor/people/tbm613/seurat_merged.rds")
saveRDS(ht_list, file = "/maps/projects/thor/people/tbm613/hashtag5.rds")
saveRDS(toc_list, file = "/maps/projects/thor/people/tbm613/toc5.rds")

# ✅ Verify hash assignments after merging
table(seurat_obj$HTO_classification.global)  # To see Singlets, Doublets, Negatives
table(seurat_obj$hash.ID)  # Check how many SZ/CON/BD groups are in the merged dataset


----------

1. VERIFY THE HTO DEMULTIPLEXING RESULTS

table(unlist(ht_list))


2. SUBSET ONLY SZ & CON
cellhash <- subset(cellhash, subset = grepl("^SZ|^CON", hash.ID))

table(cellhash$hash.ID)



Idents(cellhash) <- "HTO_classification.global"
VlnPlot(cellhash, features = "nCount_RNA", pt.size = 0)  # Compare RNA counts across classifications


table(seurat_obj$HTO_classification.global)

seurat_obj <- subset(seurat_obj, subset = HTO_classification.global == "Singlet")

2. MERGE METADATA WITH SEURAT OBJECT

metadata <- read.csv("/maps/projects/thor/people/gjl413/projects/psychENCODE/data/metadata/SZBD.metadata.csv", row.names = 1)
head(metadata)


