library(Seurat)
library(dplyr)

# Define the batch name
batch_name <- "Batch1Channel1"

# Define the correct path
h5_path <- paste0("/people/gjl413/projects/psychENCODE/data/SZBDMulti-Seq/CellrangerOutput_Intron/", 
                  batch_name, 
                  "/outs/cellbender_filtered.h5")

# Read the data from the .h5 file
counts <- Read10X_h5(filename = h5_path)

# Extract raw gene expression and antibody capture (HTO) data
toc <- as.data.frame(counts$`Gene Expression`)

# Check if Antibody Capture data exists
if ("Antibody Capture" %in% names(counts)) {
  df2 <- as.data.frame(counts$`Antibody Capture`)
  
  # Process cell hashing
  cellhash <- CreateSeuratObject(counts = df2, project = "cell_hashing", assay = "HTO")
  cellhash <- NormalizeData(cellhash, assay = "HTO", normalization.method = "CLR")
  cellhash <- HTODemux(cellhash, assay = "HTO", positive.quantile = 0.85)
  
  ht <- as.data.frame(cellhash$hash.ID)
} else {
  warning(paste("No Antibody Capture data found for", batch_name))
  ht <- NULL
}

# Save results
saveRDS(ht, file = "/maps/projects/thor/people/qdz247/thesis/CMC/hashtag_Batch1Channel1.rds")
saveRDS(toc, file = "/maps/projects/thor/people/qdz247/thesis/CMC/toc_Batch1Channel1.rds")

# Reload to check
toc <- readRDS("/maps/projects/thor/people/qdz247/thesis/CMC/toc_Batch1Channel1.rds")
ht <- readRDS("/maps/projects/thor/people/qdz247/thesis/CMC/hashtag_Batch1Channel1.rds")

metadata <- readRDS("/maps/projects/thor/people/gjl413/projects/psychENCODE/data/dataForZhenwen/full.CMC.metadata.rds")

ht
metadata
